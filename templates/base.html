<!doctype html>
<html lang="en" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %} PulseRx {% endblock %}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'dist/main.css' %}" />
    <script
      src="https://kit.fontawesome.com/8b6abeeef6.js"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />
  </head>

  <body>
  {% if user.is_authenticated %}
    <!-- Modern Navbar with DaisyUI -->
    <div class="navbar bg-white shadow-lg border-b-2 border-pulse-red">
      <div class="navbar-start">
        {% if request.user.role == 'patient' %}
        <a href="{% url 'patient_home' %}" class="btn btn-ghost text-xl font-bold text-pulse-red">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          PulseRx
        </a>
        {% elif request.user.role == 'pharmacist' %}
        <a href="{% url 'pharmacist_home' %}" class="btn btn-ghost text-xl font-bold text-pulse-red">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          PulseRx
        </a>
        {% elif request.user.role == 'pharmacy admin' %}
        <a href="{% url 'pharmacy_home' %}" class="btn btn-ghost text-xl font-bold text-pulse-red">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          PulseRx
        </a>
        {% endif %}
      </div>


      <div class="navbar-end gap-2">
        <!-- Notifications Dropdown -->
        <details class="dropdown dropdown-end">
          <summary
            id="hidden-dropdown"
            class="cursor-pointer flex items-center"
          >
            <div class="relative">
              <i id="noti-bell" class="bi bi-bell text-2xl text-pulse-gray-800"></i>
              <span
                id="notification-badge"
                class="absolute -top-1 -right-1 badge badge-xs bg-pulse-red border-pulse-red text-white"
                style="display: {% if unread_count > 0 %}inline-block{% else %}none{% endif %}"
              >
                {{unread_count}}
              </span>
            </div>
          </summary>

          <div class="dropdown-content z-[1] shadow-2xl mt-3">
            <ul class="menu bg-base-200 rounded-box w-96 p-2 noti-content">
              <li class="menu-title">
                <span class="text-lg font-semibold text-pulse-gray-800">Notifications</span>
              </li>
              {% for noti in notifications %}
              <li id="noti_div_{{noti.id}}" class="relative">
                <button class="delete-noti absolute top-2 right-2 btn btn-ghost btn-xs btn-circle" type="button" data-id="{{noti.id}}">
                  <i class="bi bi-x text-lg"></i>
                </button>
                {% if noti.reminder %}
                <a
                  id="noti-dropdown"
                  class="{% if noti.is_read %} opacity-60 {% endif %} notiDrop"
                  href="{% url 'reminders' %}#reminder_{{noti.reminder.id}}"
                  data-read="{{noti.is_read}}"
                  data-id="{{noti.id}}"
                >
                  <div class="flex flex-col gap-1">
                    <p class="reminder-message text-sm font-medium">
                      Time to take your {{noti.reminder.medicine_name}}
                    </p>
                    <p class="reminder-time text-xs text-pulse-gray-500">{{noti.time}}</p>
                  </div>
                </a>
                {% elif noti.content %}
                <a
                  id="noti-dropdown"
                  class="{% if noti.is_read %} opacity-60 {% endif %} notiDrop"
                  href="{{noti.link}}"
                  data-read="{{noti.is_read}}"
                  data-id="{{noti.id}}"
                >
                  <div class="flex flex-col gap-1">
                    <p class="reminder-message text-sm font-medium">{{noti.content}}</p>
                    <p class="reminder-time text-xs text-pulse-gray-500">{{noti.time}}</p>
                  </div>
                </a>
                {% else %}
                <a
                  id="noti-dropdown"
                  class="{% if noti.is_read %} opacity-60 {% endif %} notiDrop"
                  {% if noti.message.sender.role != "system" %}
                  href="{% url 'threads' thread_id=noti.message.thread.id %}#message_{{noti.message.id}}"
                  {% else %}
                  href="{{noti.message.link}}"
                  {% endif %}
                  data-read="{{noti.is_read}}"
                  data-id="{{noti.id}}"
                >
                  <div class="flex flex-col gap-1">
                    {% if noti.message.sender.role != "system" %}
                    <p class="reminder-message text-sm font-medium">
                      {{noti.message.sender.first_name}} {{noti.message.sender.last_name}} has sent you a new message.
                    </p>
                    {% else %}
                    <p class="reminder-message text-sm font-medium">{{noti.message.content}}</p>
                    {% endif %}
                    <p class="reminder-time text-xs text-pulse-gray-500">{{noti.time}}</p>
                  </div>
                </a>
                {% endif %}
              </li>
              {% endfor %}
              {% if not notifications %}
              <li id="emptyMessage">
                <span class="text-pulse-gray-500 text-sm text-center py-4">No notifications to display</span>
              </li>
              {% endif %}
            </ul>
          </div>
        </details>

        <!-- Settings Link -->
        <a href="{% url 'account_settings' %}" class="cursor-pointer" title="Settings">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-pulse-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
        </a>

        <!-- Logout Button -->
        <a href="{% url 'logout' %}" class="btn btn-sm bg-pulse-red border-pulse-red hover:bg-pulse-red-dark text-white">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Logout
        </a>
      </div>
    </div>
  {% endif %}
  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie("csrftoken");

    document.addEventListener("DOMContentLoaded", () => {
      const formatters = {
        patient: (p) => `${p.first_name} ${p.last_name} ID: ${p.id}`,
        medicine: (m) => `${m.name}(${m.brand}) ID: ${m.id}`,
      };

      const linkGenerators = {
        patient: (item) => `/pharmacy/patient_profile/${item.id}`,
        medicine: (item) => `/pharmacy/drug_detail/${item.id}`,
      };

      const inputs = document.querySelectorAll(".autocomplete-input");

      inputs.forEach((input) => {
        const type = input.dataset.type;
        const url = input.dataset.url;
        const email = input.dataset.email === "yes";
        const searchType = input.dataset.link === "yes";
        const resultsContainer = document.getElementById(
          `autocompleteResults-${type}`,
        );
        const hiddenInput = document.querySelector(`.hidden-${type}`);
        let timeoutId;

        input.addEventListener("keyup", function () {
          clearTimeout(timeoutId);
          const query = this.value.trim();

          if (query.length === 0) {
            resultsContainer.innerHTML = "";
            resultsContainer.classList.add("hidden");
            return;
          }

          // Hide all other autocomplete dropdowns
          document.querySelectorAll('[id^="autocompleteResults-"]').forEach(dropdown => {
            if (dropdown !== resultsContainer) {
              dropdown.innerHTML = "";
              dropdown.classList.add("hidden");
            }
          });

          timeoutId = setTimeout(() => {
            fetch(
              `${url}?q=${encodeURIComponent(query)}&email=${email ? "yes" : "no"}`,
            )
              .then((response) => {
                if (!response.ok) {
                  throw new Error(`HTTP error status: ${response.status}`);
                }
                return response.json();
              })
              .then((data) => {
                const fragment = document.createDocumentFragment();

                if (data.length > 0) {
                  data.forEach((item) => {
                    const div = document.createElement("div");
                    div.classList.add("search-item");

                    if (searchType) {
                      const searchLink = document.createElement("a");
                      searchLink.href = linkGenerators[type](item);
                      searchLink.style.display = "block";
                      searchLink.textContent = formatters[type](item);
                      div.appendChild(searchLink);
                    } else {
                      div.textContent = formatters[type](item);
                      if (email) {
                        div.textContent = `${item.first_name} ${item.last_name} ${item.email}`;
                      }
                      div.addEventListener("click", () => {
                        input.value = formatters[type](item);
                        if (email) {
                          input.value = `${item.first_name} ${item.last_name} ${item.email}`;
                        }
                        resultsContainer.innerHTML = "";
                        resultsContainer.classList.add("hidden");
                        hiddenInput.value = item.id;
                        console.log(hiddenInput);
                        console.log(hiddenInput.value);
                      });
                    }
                    fragment.appendChild(div);
                  });
                } else {
                  const div = document.createElement("div");
                  div.textContent = `No ${type} found.`;
                  div.classList.add("no-results");
                  fragment.appendChild(div);
                }

                resultsContainer.innerHTML = "";
                resultsContainer.appendChild(fragment);
                resultsContainer.classList.remove("hidden");
              })
              .catch((error) => {
                console.error(`Error fetching ${type} data:`, error);
                resultsContainer.innerHTML = `<div class="error-message">Error loading results. Please try again.</div>`;
              });
          }, 300);
        });
      });

      flatpickr(".datepicker", {
        dateFormat: "m-d-Y",
        allowInput: true,
      });

      const dropdownSummary = document.getElementById("hidden-dropdown");
      const dropdownDetails = dropdownSummary.parentElement;
      const bellIcon = document.getElementById("noti-bell");

      const setIcon = (isFilled) => {
        bellIcon.classList.toggle("bi-bell-fill", isFilled);
        bellIcon.classList.toggle("bi-bell", !isFilled);
      };

      // Listen for details toggle event
      dropdownDetails.addEventListener("toggle", () => {
        setIcon(dropdownDetails.open);
      });

      dropdownSummary.addEventListener("mouseenter", () => setIcon(true));
      dropdownSummary.addEventListener("mouseleave", () => {
        if (!dropdownDetails.open) setIcon(false);
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      // Unified scroll & highlight function
      function scrollToMessage(hash) {
        if (!hash) return;
        const target = document.querySelector(hash);
        if (!target) return;

        target.scrollIntoView({ behavior: "smooth", block: "center" });
        target.classList.add("highlight");

        const observer = new IntersectionObserver(
          (entries, obs) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                setTimeout(() => target.classList.remove("highlight"), 500);
                obs.disconnect();
              }
            });
          },
          { threshold: 0.8 },
        );

        observer.observe(target);
      }

      document
        .querySelector(".noti-content")
        .addEventListener("click", (event) => {
          const clickedItem = event.target.closest(".notiDrop");
          if (!clickedItem) return;

          const notification_id = clickedItem.dataset.id;
          const isUnread = clickedItem.dataset.read === "False";

          // OPTIMISTIC UPDATE: Update UI immediately before server responds
          if (isUnread) {
            // Mark notification as read visually
            clickedItem.classList.add("read");
            clickedItem.dataset.read = "True";

            // Decrement the badge count immediately
            const notifBadge = document.getElementById("notification-badge");
            if (notifBadge) {
              const currentCount = parseInt(notifBadge.textContent) || 0;
              const newCount = Math.max(0, currentCount - 1);
              notifBadge.textContent = newCount;
              notifBadge.style.display = newCount > 0 ? "inline-block" : "none";
            }
          }

          // Send request to server (WebSocket will send authoritative count back)
          fetch("/accounts/read_notification", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ notification_id: notification_id }),
          })
            .then((response) => response.json())
            .then((data) => {
              // WebSocket will send the authoritative count, so we don't need to do anything here
              if (!data.success) {
                console.error(
                  "Failed to mark notification as read:",
                  data.error,
                );
              }
            })
            .catch((error) =>
              console.error("Error marking notification as read:", error),
            );

          // Scroll to message if on the same page
          const href = clickedItem.getAttribute("href");
          if (href && href.includes("#")) {
            const hash = href.substring(href.indexOf("#"));
            scrollToMessage(hash);
          }
        });

      const hashOnLoad = window.location.hash;
      if (hashOnLoad) scrollToMessage(hashOnLoad);
    });

    const empty_message = document.getElementById("emptyMessage");

    function updateEmptyMessage() {
      const notiDrop = document.querySelectorAll(".notiDrop");
      if (empty_message) {
        empty_message.style.display = notiDrop.length > 0 ? "none" : "block";
      }
    }

    document
      .querySelector(".noti-content")
      .addEventListener("click", function (e) {
        const btn = e.target.closest(".delete-noti");
        if (!btn) return;

        e.stopPropagation();
        const notification_id = btn.dataset.id;
        const noti_div = document.getElementById(`noti_div_${notification_id}`);

        fetch("/accounts/delete_notification", {
          method: "POST",
          headers: {
            "X-CSRFTOKEN": csrftoken,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ notification_id: notification_id }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(
                `Deleted notification ${notification_id} successfully`,
              );
              noti_div?.remove();
              updateEmptyMessage();
            }
          })
          .catch((error) => console.error("Notification error:", error));
      });
  </script>
  {% if request.user.is_authenticated %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const noti_content = document.querySelector(".noti-content");
      const message_link = document.getElementById("message-link");
      const notifBadge = document.getElementById("notification-badge");

      // Thread ID only exists on the thread page
      const threadEl = document.querySelector(".current_thread");
      const threadId = threadEl ? threadEl.dataset.currentThread : null;

      const protocol = window.location.protocol === "https:" ? "wss" : "ws";
      const socket = new WebSocket(
        `${protocol}://127.0.0.1:8000/ws/notifications/`,
      );

      socket.onopen = () => {
        console.log("Connected to notification WS");

        // Send current thread AFTER WS opens
        if (threadId) {
          socket.send(
            JSON.stringify({
              type: "set_current_thread",
              thread_id: threadId,
            }),
          );
        }
      };

      socket.onerror = (err) => console.error("WebSocket error:", err);
      socket.onclose = () => console.log("Notification socket closed");

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("WS message:", data);

        if (
          data.notification &&
          data.notification.unread_count !== undefined &&
          !data.notification.id
        ) {
          const unread_count = data.notification.unread_count;
          const unread_messages = data.notification.unread_messages;

          // Update NOTIFICATION badge
          if (notifBadge) {
            notifBadge.textContent = unread_count;
            notifBadge.style.display =
              unread_count > 0 ? "inline-block" : "none";
          }

          // Update MESSAGE badge
          updateMessageBadge(unread_messages);

          return;
        }

        if (!data.notification) return;

        const notification = data.notification;

        if (notification.unread_count !== undefined) {
          if (notifBadge) {
            notifBadge.textContent = notification.unread_count;
            notifBadge.style.display =
              notification.unread_count > 0 ? "inline-block" : "none";
          }
        }

        appendNotification(notification);
        updateEmptyMessage();

        // If this notification belongs to a thread AND user is viewing that thread, hide badge
        if (threadId && notification.thread_id == threadId) {
          updateMessageBadge(0); // Hide message badge if viewing this thread
        } else if (notification.unread_messages !== undefined) {
          updateMessageBadge(notification.unread_messages); // Normal update
        }

        // Dispatch custom event for other pages (like messages.html) to listen to
        const notificationEvent = new CustomEvent("newNotification", {
          detail: notification,
        });
        document.dispatchEvent(notificationEvent);
      };

      // --------------------------
      // ðŸ”¹ Helper #1: message badge updater
      // --------------------------
      function updateMessageBadge(count) {
        let mbadge = document.getElementById("message-badge");

        if (!message_link) return; // no message nav icon

        if (!mbadge) {
          mbadge = document.createElement("span");
          mbadge.id = "message-badge";
          mbadge.className = "badge bg-pulse-red border-pulse-red text-white ml-1";
          message_link.appendChild(mbadge);
        }

        mbadge.textContent = count;
        mbadge.style.display = count > 0 ? "inline-block" : "none";
      }

      // --------------------------
      // ðŸ”¹ Helper #2: append notification HTML
      // --------------------------
      function appendNotification(notification) {
        const li = document.createElement("li");
        li.id = `noti_div_${notification.id}`;
        li.classList.add("relative");

        const delete_button = document.createElement("button");
        delete_button.classList.add("delete-noti", "absolute", "top-2", "right-2", "btn", "btn-ghost", "btn-xs", "btn-circle");
        delete_button.type = "button";
        delete_button.dataset.id = notification.id;

        const delete_icon = document.createElement("i");
        delete_icon.classList.add("bi", "bi-x", "text-lg");
        delete_button.appendChild(delete_icon);

        li.appendChild(delete_button);

        const link = document.createElement("a");
        link.id = "noti-dropdown";
        link.classList.add("notiDrop");
        if (notification.is_read) {
          link.classList.add("opacity-60");
        }
        link.dataset.id = notification.id;
        link.dataset.read = notification.is_read;

        // Reminder notification
        if (notification.type === "reminder") {
          const reminderUrl = "{% url 'reminders' %}";
          link.href = `${reminderUrl}#reminder_${notification.reminder_id}`;

          link.innerHTML = `
            <div class="flex flex-col gap-1">
              <p class="reminder-message text-sm font-medium text-wrap break-words pr-8">Time to take your ${notification.reminder}</p>
              <p class="reminder-time text-xs text-pulse-gray-500">${notification.created_time}</p>
            </div>
          `;
        }
        // System notification (prescription, refill, etc.) - has content field
        else if (notification.type && notification.content) {
          link.href = notification.link || "#";

          link.innerHTML = `
            <div class="flex flex-col gap-1">
              <p class="reminder-message text-sm font-medium text-wrap break-words pr-8">${notification.content}</p>
              <p class="reminder-time text-xs text-pulse-gray-500">${notification.timestamp}</p>
            </div>
          `;
        }
        // Regular message notification
        else {
          const threadUrl = "{% url 'threads' thread_id=0 %}".replace(
            "0",
            notification.thread_id,
          );

          link.href = `${threadUrl}#message_${notification.message_id}`;

          link.innerHTML = `
            <div class="flex flex-col gap-1">
              <p class="reminder-message text-sm font-medium text-wrap break-words pr-8">${notification.sender} has sent you a new message.</p>
              <p class="reminder-time text-xs text-pulse-gray-500">${notification.timestamp}</p>
            </div>
          `;
        }

        li.appendChild(link);

        // Insert after the menu-title (first li in the list)
        const menuTitle = noti_content.querySelector(".menu-title");
        if (menuTitle) {
          menuTitle.insertAdjacentElement("afterend", li);
        } else {
          // If no menu-title, insert at the beginning
          const firstChild = noti_content.firstElementChild;
          if (firstChild) {
            firstChild.insertAdjacentElement("beforebegin", li);
          } else {
            noti_content.appendChild(li);
          }
        }
      }
    });
  </script>
  {% endif %}

  <div class="min-h-screen bg-gradient-to-br from-pulse-cream to-white">
    {% block content %}{% endblock %}
  </div>

  </body>
</html>
