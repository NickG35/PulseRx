{% extends 'base.html' %}

{% block content %}
    <script>
        // Disable browser's automatic scroll restoration
        if ('scrollRestoration' in history) {
            history.scrollRestoration = 'manual';
        }

        document.addEventListener("DOMContentLoaded", () => {
            const threadId = document.querySelector('input[name="thread_id"]').value;
            const messageConvo = document.querySelector('.message-convo');
            const messagesContainer = document.querySelector('.message-convo .space-y-4');
            const empty_message = document.getElementById('noMessage');
            const newMessageBubble = document.getElementById('new-message-bubble');

            console.log("Message container found:", messagesContainer ? "YES" : "NO");

            function updateEmptyMessage(){
                const messageBox = document.querySelectorAll('.message-box');
                empty_message.style.display = messageBox.length > 0 ? 'none' : 'block';
            }

            updateEmptyMessage();

            const protocol = window.location.protocol === "https:" ? "wss": "ws";
            const socket = new WebSocket(`${protocol}://${window.location.host}/ws/messages/${threadId}/`);

            function isScrolledToBottom() {
                return messageConvo.scrollHeight - messageConvo.scrollTop <= messageConvo.clientHeight + 5;
            }

            function isLastMessageVisible() {
                const messages = document.querySelectorAll('.message-box');
                if (messages.length === 0) return true;

                const lastMessage = messages[messages.length - 1];
                const rect = lastMessage.getBoundingClientRect();
                const containerRect = messageConvo.getBoundingClientRect();

                return rect.bottom <= containerRect.bottom;
            }

            function scrollToBottom(instant = false) {
                messageConvo.scrollTo({
                    top: messageConvo.scrollHeight,
                    behavior: instant ? 'instant' : 'smooth'
                });
            }

            scrollToBottom(true); // Instant scroll to bottom on page load

            function highlightMessage(msgEl, duration=1500) {
                msgEl.classList.add('highlight');
                setTimeout(() => msgEl.classList.remove('highlight'), duration);
            }

            socket.onopen = () => console.log("Connected to message WebSocket");

            socket.onerror = (error) => {
                console.error("WebSocket error:", error);
            };

            socket.onclose = (event) => {
                console.log("WebSocket closed:", event.code, event.reason);
            };

            socket.onmessage = (event) => {
                try {
                    console.log("Received WebSocket message:", event.data);
                    const data = JSON.parse(event.data);

                    const isSender = data.sender === "{{ request.user.first_name }} {{ request.user.last_name }}";

                    // Create outer wrapper div with flex alignment
                    const messageWrapper = document.createElement('div');
                    messageWrapper.classList.add('flex', 'items-start');
                    messageWrapper.classList.add(isSender ? 'justify-end' : 'justify-start');

                    // Create message bubble
                    const messageBox = document.createElement('div');
                    messageBox.classList.add('message-box', 'min-w-48', 'max-w-md', 'p-4', 'rounded-lg', 'shadow-sm');
                    messageBox.id = `message_${data.id}`;

                    if (isSender) {
                        messageBox.classList.add('bg-pulse-red', 'text-white');
                    } else {
                        messageBox.classList.add('bg-pulse-gray-200', 'text-black');
                    }

                    // Create inner content wrapper
                    const contentWrapper = document.createElement('div');
                    contentWrapper.classList.add('flex', 'flex-col', 'gap-2');

                    // Create sender
                    let messageSender = document.createElement('strong');
                    messageSender.classList.add('message-sender', 'text-sm');
                    if (!isSender) {
                        messageSender.classList.add('text-pulse-gray-700');
                    }
                    messageSender.textContent = isSender ? 'Me' : data.sender;

                    // Create message content
                    let messageContent = document.createElement('p');
                    messageContent.classList.add('message-content', 'break-words');
                    messageContent.textContent = data.content;

                    // Create timestamp
                    let messageTime = document.createElement('small');
                    messageTime.classList.add('message-time', 'text-xs', 'text-right');
                    if (isSender) {
                        messageTime.classList.add('opacity-75');
                    } else {
                        messageTime.classList.add('text-pulse-gray-600');
                    }
                    messageTime.textContent = data.timestamp;

                    // Assemble the structure
                    contentWrapper.appendChild(messageSender);
                    contentWrapper.appendChild(messageContent);
                    contentWrapper.appendChild(messageTime);
                    messageBox.appendChild(contentWrapper);
                    messageWrapper.appendChild(messageBox);

                    // Add to the messages container
                    if (messagesContainer) {
                        messagesContainer.appendChild(messageWrapper);
                        console.log("Message appended successfully");
                    } else {
                        console.error("Messages container not found!");
                    }

                    updateEmptyMessage();

                    if (isScrolledToBottom() || isLastMessageVisible()){
                        scrollToBottom(true); // Use instant scroll to stay at bottom without animation
                        newMessageBubble.style.display = 'none';
                    } else if (!isSender) {
                        // Only show bubble for received messages that are off-screen
                        newMessageBubble.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error in socket.onmessage:", error);
                }
            }

            newMessageBubble.addEventListener('click', () => {
                scrollToBottom();
                newMessageBubble.style.display = 'none';
            });

            // Hide bubble when user scrolls and messages come into view
            messageConvo.addEventListener('scroll', () => {
                if (isScrolledToBottom() || isLastMessageVisible()) {
                    newMessageBubble.style.display = 'none';
                }
            });

            const form = document.getElementById('message-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const content = form.querySelector('textarea[name="content"]').value.trim();
                if (!content) return;
                socket.send(JSON.stringify({content}));
                form.reset();
            });

            
        });

               
    </script>

<div class="p-6">
    <p class="current_thread" style="display:none;" data-current-thread="{{thread.id}}"></p>

    <!-- Page Header -->
    <div class="mb-8 text-center">
        {% if thread.other_participants %}
            <h1 class="text-4xl font-bold text-pulse-gray-800 mb-2">
                {% for user in thread.other_participants %}
                    {% if user.role == "system" %}
                        Notification System
                    {% elif user.role == "pharmacy admin" or user.role == "pharmacist" %}
                        {{ user.pharmacyprofile.pharmacy_name }} Pharmacy
                    {% else %}
                        {{ user.first_name }} {{ user.last_name }}
                    {% endif %}
                {% endfor %}
            </h1>
        {% else %}
            <h1 class="text-4xl font-bold text-pulse-gray-800 mb-2">No participant found</h1>
        {% endif %}
    </div>

    <!-- Messages Container -->
    <div class="max-w-3xl mx-auto">
        <div class="message-convo bg-white border border-pulse-gray-300 rounded-lg shadow-sm p-6 mb-4 min-h-[400px] max-h-[500px] overflow-y-scroll relative">
            <!-- New Message Bubble -->
            <div id="new-message-bubble" class="fixed bottom-24 right-8 bg-pulse-red text-white px-4 py-2 rounded-full shadow-lg cursor-pointer hover:bg-pulse-red-dark transition-colors" style="display: none;">
                <i class="fa-solid fa-arrow-down mr-2"></i>
                New messages
            </div>

            <!-- Empty State -->
            <div id="noMessage" class="text-center py-16" {% if messages %} style="display: none;" {% endif %}>
                <i class="fa-regular fa-comments text-6xl text-pulse-gray-300 mb-4"></i>
                <p class="text-pulse-gray-500 text-lg">No messages yet</p>
                <p class="text-pulse-gray-400 text-sm mt-2">Start the conversation below</p>
            </div>

            <!-- Messages -->
            <div class="space-y-4">
                {% for message in messages %}
                    {% if message.sender == request.user %}
                        <div class="flex justify-end items-start">
                            <div class="message-box bg-pulse-red text-white min-w-48 max-w-md p-4 rounded-lg shadow-sm" id="message_{{ message.id }}" data-read="{{ message.user_read }}">
                                <div class="flex flex-col gap-2">
                                    <strong class="message-sender text-sm">Me</strong>
                                    <p class="message-content break-words">{{ message.content }}</p>
                                    {% if message.link %}
                                        <a href="{{ message.link }}" class="text-sm underline hover:no-underline">View details</a>
                                    {% endif %}
                                    <small class="message-time text-xs opacity-75 text-right">{{ message.timestamp }}</small>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="flex justify-start items-start">
                            <div class="message-box bg-pulse-gray-200 text-black min-w-48 max-w-md p-4 rounded-lg shadow-sm" id="message_{{ message.id }}" data-read="{{ message.user_read }}">
                                <div class="flex flex-col gap-2">
                                    <strong class="message-sender text-sm text-pulse-gray-700">{{ message.sender.first_name }} {{ message.sender.last_name }}</strong>
                                    <p class="message-content break-words">{{ message.content }}</p>
                                    {% if message.link %}
                                        <a href="{{ message.link }}" class="text-sm text-pulse-red underline hover:no-underline">View details</a>
                                    {% endif %}
                                    <small class="message-time text-xs text-pulse-gray-600 text-right">{{ message.timestamp }}</small>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Message Input Form -->
        {% if other_user.role != 'system' %}
            <form class="flex gap-3 items-end" id="message-form">
                {% csrf_token %}
                {{ form.content }}
                <input type="hidden" name="thread_id" value="{{ thread.id }}">
                <button type="submit" class="btn btn-circle bg-pulse-red hover:bg-pulse-red-dark text-white border-none flex-shrink-0">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </form>
        {% else %}
            <div class="text-center p-4 bg-pulse-gray-100 rounded-lg">
                <i class="fa-solid fa-lock text-pulse-gray-400 mr-2"></i>
                <span class="text-pulse-gray-600">You cannot reply to system notifications</span>
            </div>
        {% endif %}
    </div>
</div>

{% endblock %}