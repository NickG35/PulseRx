{% extends 'base.html' %}

{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const empty_message = document.getElementById('noMessage');

        function updateEmptyMessage(){
            const threadBox = document.querySelectorAll('.thread-box');
            empty_message.style.display = threadBox.length > 0 ? 'none': 'block';
        }

        updateEmptyMessage();
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
                return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        const form = document.getElementById('message-form');
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            fetch('/accounts/send_messages', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                },
                body: new FormData(form)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateEmptyMessage();
                    let threadBox = document.getElementById(`thread_${data.thread_id}`);

                    if (!threadBox) {
                        // Create a new thread container
                        threadBox = document.createElement('div');
                        threadBox.classList.add('thread-box');
                        threadBox.id = `thread_${data.thread_id}`;

                        // Add it to threads container
                        document.getElementById('threads-box').prepend(threadBox);
                    }

                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('message-box');
                    messageDiv.id = `message_${data.id}`;
                    messageDiv.dataset.read = data.read;

                    // Differentiate sender/recipient visually
                    const sender = document.createElement('p');
                    sender.classList.add('message-sender');
                    sender.textContent = data.sender;

                    const content = document.createElement('p');
                    content.classList.add('message-content');
                    content.textContent = data.content;

                    const timestamp = document.createElement('p');
                    timestamp.classList.add('message-timestamp');
                    timestamp.innerHTML = `<small>${data.timestamp}</small>`;

                    messageDiv.appendChild(sender);
                    messageDiv.appendChild(content);
                    messageDiv.appendChild(timestamp);

                    // Insert message at bottom of this thread
                    threadBox.appendChild(messageDiv);

                    // Reset form
                    form.reset();

                    updateEmptyMessage();
                }
            })
            .catch(error => console.error("Notification error:", error));
        })
    });
</script>
<p>These are my pharmacy messages</p>

<form id="message-form" method="post">
    {% csrf_token %}
    <label for="id_sender">From:</label>
    <input type="text" id="id_sender" value="{{request.user.first_name}} {{request.user.last_name}} {{ request.user.email }}>" disabled>
    {% if request.user.role == 'pharmacist' or request.user.role == 'pharmacy admin' %}
        <input placeholder="To:"  type="text" class="autocomplete-input" data-type="patient" data-url="{% url 'patient_search' %}" data-email="yes" data-link="no">
        <input name="recipient" type="hidden" class="hidden-patient">
        <div id="autocompleteResults-patient"></div>
    {% else %}
        <label for="id_receiver">To:</label>
        <input id="id_receiver" type="text" value="{{pharmacy_email}}" disabled>
    {% endif %}
    {{form.as_p}}

    <button type="submit">Send</button>
</form>
<div id="threads-box">
    {% for thread in threads %}
        <a href="{% url 'threads' thread_id=thread.id%}">
            <div class="thread-box" id="thread_{{ thread.id }}">
                {% with latest=thread.latest_message %}
                    {% if latest %}
                        <div class="message-box" id="message_{{ latest.id }}" data-read="{{ latest.read }}">
                            <p class="message-sender"><strong>{{ latest.sender.email }}</strong></p>
                            <p class="message-content">{{ latest.content }}</p>
                            <p class="message-timestamp"><small>{{ latest.timestamp }}</small></p>
                        </div>
                    {% endif %}
                {% endwith %}
            </div>
        </a>
    {% endfor %}
        <p id="noMessage" {% if threads %} style="display: none;" {% endif %}>No messages yet.</p>
</div>
{% endblock %}