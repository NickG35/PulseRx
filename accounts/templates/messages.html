{% extends 'base.html' %}

{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', () => {

        const input = document.querySelector('.autocomplete-message');
        const results = document.getElementById('autocompleteResults');
        let timeoutId;

        input.addEventListener('keyup', function(){
            clearTimeout(timeoutId);
            const query = this.value.trim();

            if (query.length === 0){
                results.innerHTML = '';
                return;
            }

            timeoutId = setTimeout(() => {
                fetch(`/accounts/message_search?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error status: ${response.status}`);
                        }
                        return response.json()
                    })
                    .then(data => {
                        const fragment = document.createDocumentFragment();

                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('search-message');

                                const threadUrl = `/accounts/thread/${item.thread_id}`;
                                const linkMessage = document.createElement('a');
                                linkMessage.href = `${threadUrl}#message_${item.id}`;
                                linkMessage.style.display = 'block';
                                linkMessage.textContent = item.content;
                                div.appendChild(linkMessage);

                                fragment.appendChild(div);
                            })
                        } else {
                            const div = document.createElement('div');
                            div.textContent = `No messages found.`
                            fragment.appendChild(div);
                        }

                        results.innerHTML = '';
                        results.appendChild(fragment); 
                    })
                    .catch(error => {
                        console.error(`Error fetching message data:`, error);
                        results.innerHTML = `<div class="error-message">Error loading results. Please try again.</div>`;
                    });
            }, 300);
        });

        const threadBtn = document.querySelector('.threadSearch');
        threadBtn.addEventListener('click', function(){
            peopleInput.style.display = 'block';
        })
    });
</script>
<p>These are my pharmacy messages</p>


    <input placeholder="search messages..." type="text" class="autocomplete-message">
    <div id="autocompleteResults"></div>

    {% if request.user.role == 'patient' %}
        <form action="{% url 'patient_thread' %}" method="post" style="display:inline;">
            {% csrf_token %}
            <input type="hidden" name="patientID" value="{{ request.user.id }}">
            <button type="submit"><i class="fa-regular fa-pen-to-square"></i></button>
        </form>
    {% else %}
        <button class="threadSearch" type="button"><i class="fa-regular fa-pen-to-square"></i></button>
        <form action="{% url 'patient_thread' %}" method="post">
            {% csrf_token %}
            <input placeholder="search for patients..." type="text" id="autocomplete-people" class="autocomplete-input" data-type="patient" data-url="{% url 'patient_search' %}">
            <input name="patientID" type="hidden" class="hidden-patient">
            <div class="autocompletePeople" id="autocompleteResults-patient"></div>
            <button type="submit">Search</button>
        </form>
    {% endif %}

<div id="threads-box">
    {% for thread in threads %}
    <a href="{% url 'threads' thread_id=thread.id %}">
        <div class="thread-box" id="thread_{{ thread.id }}">
            {% with latest=thread.latest_message %}
                {% if latest %}
                    <div class="message-box" id="message_{{ latest.id }}" data-read="{{ latest.read }}">
                        <p class="message-sender">
                            <strong>
                            {% if request.user.role == 'patient' %}
                                {{ pharmacy_name }} Pharmacy
                            {% else %}
                                {% for patient in thread.patients %}
                                    {{ patient.first_name }} {{ patient.last_name }}
                                {% endfor %}
                            {% endif %}
                            </strong>
                        </p>

                        {% if latest.sender == request.user %}
                            <span>Me:</span>
                        {% else %}
                            <span>{{ latest.sender.first_name }} {{ latest.sender.last_name }}:</span>
                        {% endif %}

                        <p class="message-content">{{ latest.content }}</p>
                        <p class="message-timestamp"><small>{{ latest.timestamp }}</small></p>
                    </div>
                {% endif %}
            {% endwith %}
        </div>
    </a>
{% endfor %}
        <p id="noMessage" {% if threads %} style="display: none;" {% endif %}>No messages yet.</p>
</div>
{% endblock %}