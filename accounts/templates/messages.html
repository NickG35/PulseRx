{% extends 'base.html' %}

{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', () => {

        const input = document.querySelector('.autocomplete-message');
        const results = document.getElementById('autocompleteResults');
        let timeoutId;

        input.addEventListener('keyup', function(){
            clearTimeout(timeoutId);
            const query = this.value.trim();

            if (query.length === 0){
                results.innerHTML = '';
                return;
            }

            timeoutId = setTimeout(() => {
                fetch(`/accounts/message_search?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error status: ${response.status}`);
                        }
                        return response.json()
                    })
                    .then(data => {
                        const fragment = document.createDocumentFragment();

                        if (data.length > 0) {
                            data.forEach(item => {
                                const div = document.createElement('div');
                                div.classList.add('search-message');

                                const threadUrl = `/accounts/thread/${item.thread_id}`;
                                const linkMessage = document.createElement('a');
                                linkMessage.href = `${threadUrl}#message_${item.id}`;
                                linkMessage.style.display = 'block';
                                linkMessage.textContent = item.content;
                                linkMessage.classList.add('link-messages');
                                div.appendChild(linkMessage);

                                fragment.appendChild(div);
                            })
                        } else {
                            const div = document.createElement('div');
                            div.textContent = `No messages found.`
                            div.classList.add('link-messages');
                            fragment.appendChild(div);
                        }

                        results.innerHTML = '';
                        results.appendChild(fragment); 
                    })
                    .catch(error => {
                        console.error(`Error fetching message data:`, error);
                        results.innerHTML = `<div class="error-message">Error loading results. Please try again.</div>`;
                    });
            }, 300);
        });

        const threadBtn = document.querySelector('.threadSearch');
        threadBtn.addEventListener('click', function(){
            peopleInput.style.display = 'block';
        })

        window.addEventListener("pageshow", function (event) {
            if (event.persisted || performance.getEntriesByType("navigation")[0].type === "back_forward") {
                const hiddenPatient = document.querySelector(".hidden-patient");
                if (hiddenPatient) hiddenPatient.value = "";
                document.querySelector('.autocomplete-message').value = "";
                document.getElementById("autocomplete-people").value = "";
            }
        });

        // Listen for new notifications from base.html
        document.addEventListener('newNotification', (event) => {
            const notification = event.detail;

            // Only handle message notifications (not reminders or system notifications)
            if (notification.thread_id && notification.message_id && !notification.type) {
                updateOrCreateThread(notification);
            }
        });

        function updateOrCreateThread(notification) {
            const threadBox = document.getElementById(`thread_${notification.thread_id}`);

            if (threadBox) {
                // Thread exists - update it
                updateThreadPreview(notification, threadBox);
            } else {
                // Thread doesn't exist - create it
                createNewThread(notification);
            }
        }

        function updateThreadPreview(notification, threadBox) {
            // Update the message content
            const messageContent = threadBox.querySelector('.message-content');
            if (messageContent) {
                messageContent.textContent = notification.content;
            }

            // Update the sender
            const senderSpan = threadBox.querySelector('.message-box span');
            if (senderSpan) {
                const isMe = notification.sender === "{{ request.user.first_name }} {{ request.user.last_name }}";
                senderSpan.textContent = isMe ? 'Me:' : `${notification.sender}:`;
            }

            // Update the timestamp
            const messageTimestamp = threadBox.querySelector('.message-timestamp small');
            if (messageTimestamp) {
                messageTimestamp.textContent = notification.timestamp;
            }

            // Move thread to top
            const threadsBox = document.getElementById('threads-box');
            const threadLink = threadBox.closest('a');
            if (threadsBox && threadLink) {
                threadsBox.insertBefore(threadLink, threadsBox.firstChild);
            }
        }

        function createNewThread(notification) {
            const threadsBox = document.getElementById('threads-box');
            const noMessage = document.getElementById('noMessage');

            if (!threadsBox) return;

            // Determine thread name based on user role and notification data
            let threadName = notification.sender;

            // Create new thread element
            const threadLink = document.createElement('a');
            threadLink.href = `/accounts/thread/${notification.thread_id}`;

            const threadDiv = document.createElement('div');
            threadDiv.className = 'thread-box';
            threadDiv.id = `thread_${notification.thread_id}`;

            const messageBox = document.createElement('div');
            messageBox.className = 'message-box';
            messageBox.id = `message_${notification.message_id}`;

            const isMe = notification.sender === "{{ request.user.first_name }} {{ request.user.last_name }}";

            messageBox.innerHTML = `
                <p class="message-sender">
                    <strong>${threadName}</strong>
                </p>
                <span>${isMe ? 'Me:' : notification.sender + ':'}</span>
                <p class="message-content">${notification.content}</p>
                <p class="message-timestamp"><small>${notification.timestamp}</small></p>
            `;

            threadDiv.appendChild(messageBox);
            threadLink.appendChild(threadDiv);

            // Insert at top of threads list
            threadsBox.insertBefore(threadLink, threadsBox.firstChild)

            // Hide "No messages yet" message
            if (noMessage) {
                noMessage.style.display = 'none';
            }
        }
    });
</script>
<div class="p-6">
<div class="mb-8">
    <h1 class="text-4xl font-bold text-pulse-gray-899 mb-2">Messages</h1>
    <p class="text-pulse-gray-600">
        {% if request.user.role == 'patient' %}
            Here are your messages between you and your pharmacy
        {% endif %}
    </p>

</div>
<div class="container mx-auto px-4">

    <div class="flex flex-row items-center gap-4 max-w-2xl mb-4 mx-auto">
        <div class="relative flex-1">
            <label class="input input-lg w-full border-2 border-pulse-gray focus-within:outline-none shadow-md">
                <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <g
                    stroke-linejoin="round"
                    stroke-linecap="round"
                    stroke-width="2.5"
                    fill="none"
                    stroke="currentColor"
                    >
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.3-4.3"></path>
                    </g>
                </svg>
                <input placeholder="search messages..." type="search" class="autocomplete-message focus-within:outline-none w-full">
            </label>
            <div id="autocompleteResults" class="absolute top-full left-0 right-0  bg-white border-2 border-t-0 border-pulse-gray rounded-lg z-10 max-h-60 overflow-y-auto"></div>
        </div>
        <div class="flex-shrink-0">
            {% if request.user.role == 'patient' %}
                <form action="{% url 'patient_thread' %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="patientID" value="{{ patient.id }}">
                    <button type="submit"><i class="fa-regular fa-pen-to-square fa-xl text-pulse-gray-500"></i></button>
                </form>
            {% else %}
                <button class="threadSearch" type="button" onclick="my_modal_3.showModal()"><i class="fa-regular fa-pen-to-square fa-xl text-pulse-gray-500"></i></button>
                <dialog id="my_modal_3" class="modal">
                    <div class="modal-box">
                        <form method="dialog">
                            <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                        </form>
                        <h3 class="text-lg font-bold text-pulse-gray-800">Patient Search</h3>
                        <form action="{% url 'patient_thread' %}" method="post">
                            {% csrf_token %}
                            <input placeholder="search for patients..." type="text" id="autocomplete-people" class="autocomplete-input" data-type="patient" data-url="{% url 'patient_search' %}">
                            <input name="patientID" type="hidden" class="hidden-patient">
                            <div class="autocompletePeople" id="autocompleteResults-patient"></div>
                            <button type="submit" class="btn bg-pulse-red hover:bg-pulse-red-dark text-white border-pulse-red w-full">
                                Search
                            </button>
                        </form>
                    </div>
                </dialog>    
            {% endif %}
        </div>
    </div>

    <div class="mx-auto max-w-2xl">
        {% for thread in threads %}
            <a href="{% url 'threads' thread_id=thread.id %}">
                <div class="thread-box" id="thread_{{ thread.id }}">
                    {% with latest=thread.latest_message %}
                            <div class="message-box bg-white border-2 border-pulse-gray-300 rounded-lg p-4 mb-3 hover:bg-gray-50 transition-colors"  {% if latest %} id="message_{{ latest.id }}" {% endif %}>
                                <div class="message-sender flex flex-row items-center justify-between mb-2">
                                    <div>
                                        <strong class="text-pulse-gray-900 text-lg">
                                            {% for user in thread.other_participants %}
                                                {% if user.role == "pharmacy admin" or user.role == "pharmacist" %}
                                                    {{ user.pharmacyprofile.pharmacy_name }} Pharmacy
                                                {% else %}
                                                    {{ user.first_name }} {{ user.last_name }}
                                                {% endif %}
                                            {% endfor %}
                                        </strong>
                                    </div>
                                    <div>
                                        {% if latest %}
                                            <p class="message-timestamp text-gray-500"><small>{{ latest.timestamp }}</small></p>
                                        {% else %}
                                            <p class="message-timestamp text-gray-500"><small>{{ thread.created_at }}</small></p>    
                                        {% endif %}  
                                    </div>    
                                </div>
                                <p class="message-content text-gray-500 truncate">{% if latest %}{{ latest.content }} {% else %} No messages yet {% endif %}</p>
                            </div>
                    {% endwith %}
                </div>
            </a>
        {% endfor %}
        <p id="noMessage" {% if threads %} style="display: none;" {% endif %}>No messages yet.</p>
    </div>
</div>
</div>
{% endblock %}