{% extends 'base.html' %}

{% block content %}
<div class="p-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-pulse-gray-800 mb-2">Medication Reminders</h1>
        <p class="text-pulse-gray-600">Manage your medication schedules and stay on track with your prescriptions</p>
    </div>

    <!-- Main Content Container -->
    <div class="max-w-7xl mx-auto">

        <!-- Active Reminders Section -->
        <div class="bg-white border border-pulse-gray-300 rounded-lg p-6 mb-8">
            <!-- Header with New Button -->
            <div class="flex flex-row items-center justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-semibold text-pulse-gray-800">Active Reminders</h2>
                    <p class="text-sm text-pulse-gray-600">Your currently scheduled medication reminders</p>
                </div>
                <button class="btn btn-sm bg-pulse-red hover:bg-pulse-red-dark text-white gap-2 p-2 flex-shrink-0" onclick="my_modal_3.showModal()">
                    New
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- Create Reminder Modal -->
            <dialog id="my_modal_3" class="modal">
                <div class="modal-box">
                    <form method="dialog">
                        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">âœ•</button>
                    </form>
                    <h3 class="text-lg font-bold text-pulse-gray-800">Create a Reminder</h3>
                    <form method="post">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-error mb-4">
                                {{ form.non_field_errors }}
                            </div>
                        {% endif %}

                        <!-- Prescription Select -->
                        <div class="form-control w-full mb-4">
                            <label class="label" for="{{ form.prescription.id_for_label }}">
                                <span class="label-text text-pulse-gray-800 font-medium">Prescription</span>
                            </label>
                            {{ form.prescription }}
                        </div>

                        <!-- Frequency Select -->
                        <div class="form-control w-full mb-4">
                            <label class="label" for="{{ form.frequency.id_for_label }}">
                                <span class="label-text text-pulse-gray-800 font-medium">Frequency (times per day)</span>
                            </label>
                            {{ form.frequency }}
                        </div>

                        <!-- Dosage Suggestion -->
                        <div class="dosage-suggestion text-sm text-pulse-gray-600 mb-4"></div>

                        <!-- Time Inputs (dynamically generated) -->
                        <div id="timeInputsContainer" class="form-control w-full mb-4" style="display: none;">
                            <label class="label">
                                <span class="label-text text-pulse-gray-800 font-medium">Reminder Times</span>
                            </label>
                            <div id="timeInputs" class="space-y-2">
                                {% for val in time_values %}
                                    <input type="time" name="time_{{ forloop.counter0 }}" class="input input-bordered w-full focus:border-pulse-red focus:outline-none timeInput" value="{{val}}">
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Number of Days -->
                        <div class="form-control w-full mb-4">
                            <label class="label" for="{{ form.day_amount.id_for_label }}">
                                <span class="label-text text-pulse-gray-800 font-medium">Number of days</span>
                            </label>
                            {{ form.day_amount }}
                            {% if form.day_amount.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.day_amount.errors }}</span>
                                </label>
                            {% endif %}
                            <div class="day-suggestion text-sm text-pulse-gray-600 mt-2"></div>
                        </div>

                        <!-- Submit Button -->
                        <button type="submit" class="btn bg-pulse-red hover:bg-pulse-red-dark text-white border-pulse-red w-full">
                            Create Reminder
                        </button>
                    </form>
                </div>
            </dialog>

            <!-- Empty State -->
            <div id="active-empty-state" class="text-center py-12" {% if all_reminders %} style="display: none;" {% endif %}>
                <i class="fa-regular fa-bell-slash text-6xl text-pulse-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-pulse-gray-700 mb-2">No Active Reminders</h3>
                <p class="text-pulse-gray-500">Create your first medication reminder to get started</p>
            </div>

            <!-- Active Reminders List -->
            <div class="active_reminders space-y-4 mt-6" {% if not all_reminders %} style="display: none;" {% endif %}>
                {% for reminder in all_reminders %}
                    <div class="card bg-white shadow-lg hover:shadow-xl transition-shadow duration-300">
                        <div class="card-body p-6">
                            <div id="reminder_{{reminder.id}}" class="reminder-layout {% if reminder.is_active %}black{% else %}grayed{% endif %}">
                                <!-- Medicine name and toggle -->
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-2xl font-semibold text-pulse-gray-800">{{reminder.prescription.medicine.name}}</h3>
                                        <p class="text-sm text-pulse-gray-500">{{reminder.prescription.medicine.brand}}</p>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        <input class="toggle bg-pulse-gray-200 checked:bg-pulse-red border-pulse-gray-300 checked:border-pulse-red" type="checkbox" data-type="reminder" data-reminder="{{reminder.id}}" {% if reminder.is_active %}checked{% endif %}>
                                        <div class="dropdown dropdown-end">
                                            <div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-square hover:bg-pulse-gray-100">
                                                <i class="fa-solid fa-ellipsis text-pulse-gray-600"></i>
                                            </div>
                                            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg">
                                                <li>
                                                    <a class="edit-reminder" data-reminder="{{reminder.id}}">
                                                        <i class="fa-solid fa-pen-to-square"></i>
                                                        Edit
                                                    </a>
                                                </li>
                                                <li>
                                                    <a id="delete{{reminder.id}}" class="text-error hover:bg-error hover:text-white" data-bs-toggle="modal" data-bs-target="#modal_{{reminder.id}}">
                                                        <i class="fa-solid fa-trash"></i>
                                                        Delete
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reminder Times Section -->
                                <div class="bg-pulse-gray-50 rounded-lg p-4 mb-4">
                                    <h4 class="text-sm font-medium text-pulse-gray-700 mb-3 flex items-center gap-2">
                                        <i class="fa-solid fa-clock"></i>
                                        Reminder Times
                                    </h4>
                                    <div class="space-y-2">
                                        {% for time in reminder.times.all %}
                                            <div class="time-div flex items-center justify-between bg-white rounded px-3 py-2">
                                                <div class="flex items-center gap-3">
                                                    <i class="fa-regular fa-bell text-pulse-gray-400"></i>
                                                    <div class="original_{{reminder.id}}" data-time-id="{{time.id}}">
                                                        <p class="reminder_times text-lg font-medium text-pulse-gray-600">{{ time.time|time:"g:i A" }}</p>
                                                    </div>
                                                    <div class="editable_{{reminder.id}}">
                                                        <input type="time" name="reminder_time" id="time_{{reminder.id}}" class="input input-bordered input-sm timeInput" data-id="{{time.id}}" value="{{time.time|time:'H:i'}}">
                                                    </div>
                                                </div>
                                                <input class="toggle toggle-sm bg-pulse-gray-200 checked:bg-pulse-red border-pulse-gray-300 checked:border-pulse-red time-checkbox" type="checkbox" role="switch" data-type="time" data-id="{{time.id}}" {% if time.is_active %}checked {% endif %} {% if not reminder.is_active %} disabled {% endif %}>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Prescription Information Dropdown -->
                                <div class="collapse collapse-arrow bg-pulse-gray-50 rounded-lg">
                                    <input type="checkbox" />
                                    <div class="collapse-title text-sm font-medium flex items-center gap-2">
                                        <i class="fa-solid fa-info-circle text-pulse-gray-400"></i>
                                        View Prescription Information
                                    </div>
                                    <div class="collapse-content">
                                        <div class="space-y-3">
                                            <!-- Issued Quantity -->
                                            <div class="flex items-start gap-2 text-pulse-gray-700">
                                                <i class="fa-solid fa-pills text-pulse-gray-400"></i>
                                                <span class="font-medium">Issued Qty:</span>
                                                <span>{{reminder.prescription.quantity}}</span>
                                            </div>

                                            <!-- Days Remaining -->
                                            <div class="min-h-[2.5rem]">
                                                <div class="original_{{reminder.id}} flex items-center gap-2 text-pulse-gray-700">
                                                    <i class="fa-solid fa-calendar-days text-pulse-gray-400"></i>
                                                    <span class="font-medium">Days Remaining:</span>
                                                    <span class="remaining_days_{{reminder.id}}">{{reminder.days_left}}</span>
                                                </div>
                                                <div class="editable_{{reminder.id}} flex items-center gap-2">
                                                    <i class="fa-solid fa-calendar-days text-pulse-gray-400"></i>
                                                    <span class="font-medium text-pulse-gray-700">Days Remaining:</span>
                                                    <input type="number" min="1" step="1" name="remaining_days" class="input input-bordered input-sm w-20 edit-field" id="days_{{reminder.id}}" value="{{reminder.days_left}}">
                                                </div>
                                            </div>

                                            <!-- Dosage -->
                                            <div class="flex items-start gap-2 text-pulse-gray-700">
                                                <i class="fa-solid fa-capsules text-pulse-gray-400"></i>
                                                <span class="font-medium">Dosage:</span>
                                                <span>{{reminder.prescription.medicine.dosage}} mg</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Mode Buttons -->
                                <div class="editable_buttons_{{reminder.id}} flex gap-2 mt-4">
                                    <button type="button" class="btn btn-sm bg-pulse-gray-400 hover:bg-pulse-gray-600 text-white cancel-edit" data-reminder="{{reminder.id}}">
                                        Cancel
                                    </button>
                                    <button type="button" class="btn btn-sm bg-pulse-red hover:bg-pulse-red-dark text-white edit-save" data-reminder="{{reminder.id}}">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Modal -->
                    <div class="modal fade" id="modal_{{reminder.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Delete Reminder</h5>
                                </div>
                                <div class="modal-body">
                                    Are you sure you want to delete this reminder? This action cannot be undone.
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" id="delete_btn_{{reminder.id}}" class="btn btn-danger delete-reminder" data-reminder="{{reminder.id}}">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Archived Reminders Section -->
        <div class="collapse collapse-arrow bg-white border border-pulse-gray-300 rounded-lg">
                <input type="checkbox" />
                <div class="collapse-title text-xl font-semibold text-pulse-gray-800">
                    Archived ({{archived_reminders | length}})
                    <p class="text-sm text-pulse-gray-600 font-normal mt-1">View and restore previously completed reminders</p>
                </div>
                <div class="collapse-content">
                    <span id="empty-message" class="text-center text-pulse-gray-500 py-8" {% if archived_reminders%} style="display: none;" {% endif %}>Nothing to display yet</span>
                    <div class="space-y-4">
                        {% for reminder in archived_reminders %}
                            <div class="card bg-white shadow-lg hover:shadow-xl transition-shadow duration-300">
                                <div class="card-body p-6">
                                    <div id="reminder_{{reminder.id}}" class="reminder-layout {% if reminder.is_active %}black{% else %}grayed{% endif %}">
                                        <!-- Medicine name and toggle -->
                                        <div class="flex items-start justify-between mb-4">
                                            <div>
                                                <h3 class="text-2xl font-semibold text-pulse-gray-800">{{reminder.prescription.medicine.name}}</h3>
                                                <p class="text-sm text-pulse-gray-500">{{reminder.prescription.medicine.brand}}</p>
                                            </div>
                                            <div class="flex items-center gap-2 flex-shrink-0">
                                                <input class="toggle bg-pulse-gray-200 checked:bg-pulse-red border-pulse-gray-300 checked:border-pulse-red" type="checkbox" data-type="reminder" data-reminder="{{reminder.id}}" {% if reminder.is_active %}checked{% endif %}>
                                                <div class="dropdown dropdown-end">
                                                    <div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-square hover:bg-pulse-gray-100">
                                                        <i class="fa-solid fa-ellipsis text-pulse-gray-600"></i>
                                                    </div>
                                                    <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-52 p-2 shadow-lg">
                                                        <li>
                                                            <a class="edit-reminder" data-reminder="{{reminder.id}}">
                                                                <i class="fa-solid fa-pen-to-square"></i>
                                                                Edit
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a class="restore-button" data-reminder="{{reminder.id}}">
                                                                <i class="fa-solid fa-rotate-left"></i>
                                                                Restore
                                                            </a>
                                                        </li>
                                                        <li>
                                                            <a id="delete{{reminder.id}}" class="text-error hover:bg-error hover:text-white" data-bs-toggle="modal" data-bs-target="#modal_{{reminder.id}}">
                                                                <i class="fa-solid fa-trash"></i>
                                                                Delete
                                                            </a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Reminder Times Section -->
                                        <div class="bg-pulse-gray-50 rounded-lg p-4 mb-4">
                                            <h4 class="text-sm font-medium text-pulse-gray-700 mb-3 flex items-center gap-2">
                                                <i class="fa-solid fa-clock"></i>
                                                Reminder Times
                                            </h4>
                                            <div class="space-y-2">
                                                {% for time in reminder.times.all %}
                                                    <div class="time-div flex items-center justify-between bg-white rounded px-3 py-2">
                                                        <div class="flex items-center gap-3">
                                                            <i class="fa-regular fa-bell text-pulse-gray-400"></i>
                                                            <div class="original_{{reminder.id}}" data-time-id="{{time.id}}">
                                                                <p class="reminder_times text-lg font-medium text-pulse-gray-600">{{ time.time|time:"g:i A" }}</p>
                                                            </div>
                                                            <div class="editable_{{reminder.id}}">
                                                                <input type="time" name="reminder_time" id="time_{{reminder.id}}" class="input input-bordered input-sm timeInput" data-id="{{time.id}}" value="{{time.time|time:'H:i'}}">
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>

                                        <!-- Prescription Information Dropdown -->
                                        <div class="collapse collapse-arrow bg-pulse-gray-50 rounded-lg">
                                            <input type="checkbox" />
                                            <div class="collapse-title text-sm font-medium flex items-center gap-2">
                                                <i class="fa-solid fa-info-circle text-pulse-gray-400"></i>
                                                View Prescription Information
                                            </div>
                                            <div class="collapse-content">
                                                <div class="space-y-3">
                                                    <!-- Issued Quantity -->
                                                    <div class="flex items-start gap-2 text-pulse-gray-700">
                                                        <i class="fa-solid fa-pills text-pulse-gray-400"></i>
                                                        <span class="font-medium">Issued Qty:</span>
                                                        <span>{{reminder.prescription.quantity}}</span>
                                                    </div>

                                                    <!-- Days Remaining -->
                                                    <div class="min-h-[2.5rem]">
                                                        <div class="original_{{reminder.id}} flex items-center gap-2 text-pulse-gray-700">
                                                            <i class="fa-solid fa-calendar-days text-pulse-gray-400"></i>
                                                            <span class="font-medium">Days Remaining:</span>
                                                            <span class="remaining_days_{{reminder.id}}">{{reminder.days_left}}</span>
                                                        </div>
                                                        <div class="editable_{{reminder.id}} flex items-center gap-2">
                                                            <i class="fa-solid fa-calendar-days text-pulse-gray-400"></i>
                                                            <span class="font-medium text-pulse-gray-700">Days Remaining:</span>
                                                            <input type="number" min="1" step="1" name="remaining_days" class="input input-bordered input-sm w-20 edit-field" id="days_{{reminder.id}}" value="{{reminder.days_left}}">
                                                        </div>
                                                    </div>

                                                    <!-- Dosage -->
                                                    <div class="flex items-start gap-2 text-pulse-gray-700">
                                                        <i class="fa-solid fa-capsules text-pulse-gray-400"></i>
                                                        <span class="font-medium">Dosage:</span>
                                                        <span>{{reminder.prescription.medicine.dosage}} mg</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Edit Mode Buttons -->
                                        <div class="editable_buttons_{{reminder.id}} flex gap-2 mt-4">
                                            <button type="button" class="btn btn-sm bg-pulse-gray-400 hover:bg-pulse-gray-600 text-white cancel-edit" data-reminder="{{reminder.id}}">
                                                Cancel
                                            </button>
                                            <button type="button" class="btn btn-sm bg-pulse-red hover:bg-pulse-red-dark text-white edit-save" data-reminder="{{reminder.id}}">
                                                Save Changes
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Delete Modal -->
                            <div class="modal fade" id="modal_{{reminder.id}}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">Delete Reminder</h5>
                                        </div>
                                        <div class="modal-body">
                                            Are you sure you want to delete this reminder? This action cannot be undone.
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                            <button type="button" id="delete_btn_{{reminder.id}}" class="btn btn-danger delete-reminder" data-reminder="{{reminder.id}}">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
        </div>
    </div>
</div>

<script>
            const suggestionDay = document.querySelector('.day-suggestion');
            const suggestionDosage = document.querySelector('.dosage-suggestion');

            function createSuggestion(){
                const prescription_id = prescriptionSelect.value;
                const frequency = parseInt(frequencySelect.value);

                suggestionDay.innerHTML = "";
                suggestionDosage.innerHTML = "";


                if (prescription_id){
                    fetch("/patient/reminder_suggestions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                        body: JSON.stringify({prescription_id: prescription_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        data.results.forEach(item => {
                            const dosageInfo = document.createElement('p');
                            dosageInfo.classList.add('dosage-info');
                            dosageInfo.textContent = `Dosage information: ${item.dosage}`;
                            suggestionDosage.appendChild(dosageInfo);

                            if (frequency){
                                const quantity = item.quantity;
                                const days = Math.floor(quantity / frequency);

                                const suggestion = document.createElement('p');
                                suggestion.classList.add('daySuggestion');
                                suggestion.textContent = `Based on prescription information it is recommended that you repeat this reminder for ${days} day(s)`;
                                suggestionDay.appendChild(suggestion);
                            }   
                        });
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                } 
            }

            const selectedPrescriptionId = "{{ selected_prescription_id|default:'' }}";
            if (selectedPrescriptionId && prescriptionSelect) {
                prescriptionSelect.value = selectedPrescriptionId;
            }

            createSuggestion();

            prescriptionSelect.addEventListener('change', createSuggestion);
            frequencySelect.addEventListener('change', createSuggestion);

            const timeInputsDiv = document.getElementById('timeInputs');
            const timeInputsContainer = document.getElementById('timeInputsContainer');
            const frequencyDropdown = document.getElementById('frequency');

            frequencyDropdown.addEventListener('change', function(){
                const frequency = parseInt(this.value);

                if (frequency > 0) {
                    timeInputsContainer.style.display = 'block';
                    timeInputsDiv.innerHTML = '';

                    for (let i = 0; i < frequency; i++) {
                        const input = document.createElement('input');
                        input.type = 'time';
                        input.name = `time_${i}`;
                        input.className = 'input input-bordered w-full focus:border-pulse-red focus:outline-none timeInput';
                        input.placeholder = `Time ${i+1}`;
                        timeInputsDiv.appendChild(input);
                    }
                } else {
                    timeInputsContainer.style.display = 'none';
                    timeInputsDiv.innerHTML = '';
                }
            });

            const toggleSwitch = document.querySelectorAll('.form-check-input');
            toggleSwitch.forEach(item => {
                item.addEventListener('change', function(){
                    let url = "";
                    let payload = {};

                    const type = this.getAttribute('data-type')
                    const time_id = this.getAttribute('data-id');
                    const reminder_id = this.getAttribute('data-reminder');

                    if (time_id){
                        url = '/patient/toggle_time';
                        payload = {time_id: time_id};
                    } else if (reminder_id) {
                        url = '/patient/toggle_reminder';
                        payload = {reminder_id: reminder_id};
                    } else {
                        console.error("No valid ID found on this switch")
                        return;
                    }

                    fetch( url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success){
                            console.log(`Toggle successful for ${time_id ? 'time ' + time_id : 'reminder ' + reminder_id}`);
                            if(type === 'reminder'){
                                document.querySelector(`.remaining_days_${reminder_id}`).textContent = `${data.days_left} day(s) remaining`;
                                console.log(data.days_left);

                                const reminderLayout = this.closest('.reminder-layout');
                                reminderLayout.classList.toggle('black', this.checked);
                                reminderLayout.classList.toggle('grayed', !this.checked);

                                const timeCheckboxes = reminderLayout.querySelectorAll('.time-checkbox');

                                timeCheckboxes.forEach(cb => {
                                   if (!this.checked){
                                        cb.disabled = true;
                                        cb.checked = false;
                                   } else {
                                    cb.checked = true;
                                    cb.disabled = false;
                                   }
                                });
                            }
                        } else {
                            console.log('error: toggle failed')
                        }
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                })
            })

            const restoreButton = document.querySelectorAll('.restore-button');
            restoreButton.forEach(btn => {
                const reminder_id = btn.getAttribute('data-reminder');
                btn.addEventListener('click', function(){
                    fetch('/patient/unarchive', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                            body: JSON.stringify({reminder_id: reminder_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success){
                            console.log(`Reminder ${reminder_id} is now active`);
                            const archived_reminder = document.getElementById(`reminder_${reminder_id}`)
                            const delete_button = document.getElementById(`delete${reminder_id}`);
                            const modal = document.getElementById(`modal_${reminder_id}`);
                            const editButton = document.querySelector(`.edit-reminder[data-reminder="${reminder_id}"]`);
                            const editable_buttons = document.querySelector(`.editable_buttons_${reminder_id}`);
                            const active_container = document.querySelector('.active_reminders');

                            if (archived_reminder) {
                                const fragment = document.createDocumentFragment();
                                fragment.appendChild(editButton);
                                fragment.appendChild(archived_reminder);
                                fragment.appendChild(delete_button);
                                fragment.appendChild(modal);
                                fragment.appendChild(editable_buttons);

                                active_container.prepend(fragment);

                                archived_reminder.classList.add('black');
                                archived_reminder.classList.remove('grayed');
                                
                                editButton.style.display = 'block';

                                const archivedBody = document.querySelector('.accordion-body');
                                const reminders = archivedBody.querySelectorAll('.reminder-layout');
                                const emptyMessage = document.getElementById('empty-message');

                                if (reminders.length === 0) {
                                    emptyMessage.style.display = 'block';
                                } else {
                                    emptyMessage.style.display = 'none';
                                }

                                const reminderCheckbox = archived_reminder.querySelector('input[data-type="reminder"]');
                                if (reminderCheckbox) {
                                    reminderCheckbox.disabled = false;
                                    reminderCheckbox.checked = true;
                                }

                                archived_reminder.querySelectorAll('input[data-type="time"]').forEach(cb => {
                                    cb.disabled = false;
                                    cb.checked = true;
                                });

                                archived_reminder.querySelector('.form-check').style.display = 'block';
                                archived_reminder.querySelector(`.remaining_days_${reminder_id}`).textContent = `${data.day_amount} day(s) remaining`;

                                document.getElementById('archive-count').textContent = `Archived (${data.archive_count})`;

                                btn.remove();
                            } else {
                                console.log('error: unarchiving failed')
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                    
                })
            })

            document.querySelectorAll('.delete-reminder').forEach(btn => {
                btn.addEventListener('click', function(){
                    const reminder_id = btn.getAttribute('data-reminder');

                    fetch('/patient/delete_reminder', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                            body: JSON.stringify({reminder_id: reminder_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log(`Reminder ${reminder_id} is deleted`);
                            const selected_reminder = document.getElementById(`reminder_${reminder_id}`);
                            const delete_button = document.getElementById(`delete${reminder_id}`);
                            if(selected_reminder) selected_reminder.remove();
                            if(delete_button) delete_button.remove();

                            const modalElement = document.getElementById(`modal_${reminder_id}`);
                            const modalInstance = bootstrap.Modal.getInstance(modalElement);
                            if (modalInstance) modalInstance.hide();
                        } else {
                            console.error(data.error || "deletion failed.");
                        }
                    })
                    .catch(err => {
                        console.error("request failed", err);
                    })
                })
            })
            
            document.querySelectorAll('.edit-reminder').forEach(btn => {
                btn.addEventListener('click', function(){
                    const reminder_id = btn.getAttribute('data-reminder');
                    const editable_buttons = document.querySelectorAll(`.editable_${reminder_id}`);
                    const original_buttons = document.querySelectorAll(`.original_${reminder_id}`);
                    const edit_buttons = document.querySelector(`.editable_buttons_${reminder_id}`);

                    // Find and open the prescription info collapse to expose the editable days field
                    const reminderElement = document.getElementById(`reminder_${reminder_id}`);
                    const collapseCheckbox = reminderElement.querySelector('.collapse input[type="checkbox"]');
                    if (collapseCheckbox && !collapseCheckbox.checked) {
                        collapseCheckbox.checked = true;
                    }

                    console.log(reminder_id);
                    editable_buttons.forEach(el => {
                        el.style.display = 'block';
                    })
                    original_buttons.forEach(el => {
                        el.style.display = 'none';
                    })
                    edit_buttons.style.display = 'block';
                })
            })

            document.querySelectorAll('.cancel-edit').forEach(btn => {
                btn.addEventListener('click', function(){
                    const reminder_id = btn.getAttribute('data-reminder');
                    const editable_buttons = document.querySelectorAll(`.editable_${reminder_id}`);
                    const original_buttons = document.querySelectorAll(`.original_${reminder_id}`);
                    const edit_buttons = document.querySelector(`.editable_buttons_${reminder_id}`);

                    // Close the prescription info collapse when canceling
                    const reminderElement = document.getElementById(`reminder_${reminder_id}`);
                    const collapseCheckbox = reminderElement.querySelector('.collapse input[type="checkbox"]');
                    if (collapseCheckbox && collapseCheckbox.checked) {
                        collapseCheckbox.checked = false;
                    }

                    console.log(reminder_id);
                    editable_buttons.forEach(el => {
                        el.style.display = 'none';
                    });
                    original_buttons.forEach(el => {
                        el.style.display = 'block';
                    });
                    edit_buttons.style.display = 'none';
                })
            })

            document.querySelectorAll('.edit-save').forEach(btn => {
                btn.addEventListener('click', function(){
                    const reminder_id = btn.getAttribute('data-reminder');
                    const editable_buttons = document.querySelectorAll(`.editable_${reminder_id}`);
                    const original_buttons = document.querySelectorAll(`.original_${reminder_id}`);
                    const edit_buttons = document.querySelector(`.editable_buttons_${reminder_id}`);
                    const dayInput = document.getElementById(`days_${reminder_id}`);
                    const remaining_days = document.querySelector(`.remaining_days_${reminder_id}`);

                    const timeInputs = document.querySelectorAll(`#reminder_${reminder_id} input[name="reminder_time"]`);
                    const updated_times = Array.from(timeInputs).map(input => {
                        return {
                            id: input.getAttribute('data-id'),
                            time: input.value
                        };
                    });

                    if (!dayInput.checkValidity()) {
                        dayInput.reportValidity();
                        return;
                    }

                    // Check for duplicate times
                    const timeValues = updated_times.map(t => t.time);
                    const uniqueTimeValues = new Set(timeValues);

                    if (timeValues.length !== uniqueTimeValues.size) {
                        alert('You have duplicate reminder times. Please ensure each time is unique.');
                        return;
                    }

                    fetch('/patient/edit_reminder', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                            body: JSON.stringify({
                                reminder_id: reminder_id,
                                times: updated_times,
                                days: dayInput.value
                            })
                    })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => {
                                throw new Error(err.error || 'Update failed');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success){
                            editable_buttons.forEach(el => {
                                el.style.display = 'none';
                            });

                            original_buttons.forEach(el => {
                                el.style.display = 'block';
                            });

                            edit_buttons.style.display = 'none';

                            // Close the prescription info collapse after saving
                            const reminderElement = document.getElementById(`reminder_${reminder_id}`);
                            const collapseCheckbox = reminderElement.querySelector('.collapse input[type="checkbox"]');
                            if (collapseCheckbox && collapseCheckbox.checked) {
                                collapseCheckbox.checked = false;
                            }

                            remaining_days.innerHTML = '';
                            remaining_days.textContent = `${data.days} day(s) remaining`;

                            const times = data.times;
                            console.log(times);

                            times.forEach(time => {
                                const timeDivs = document.querySelectorAll(`.original_${reminder_id}[data-time-id="${time.id}"]`);
                                timeDivs.forEach(div => {
                                    div.innerHTML = '';
                                    const p = document.createElement('p');
                                    p.textContent = time.time;
                                    p.className = 'reminder_times';
                                    div.appendChild(p);
                                });
                            });

                            console.log(`Reminder ${reminder_id} is updated`);
                        } else {
                            alert(data.error || 'Error: reminder cannot be updated');
                        }
                    })
                    .catch(error => {
                        console.error("Error", error);
                        alert(error.message || 'An error occurred while updating the reminder');
                    });
                })
            })
        });
    </script>
{% endblock %}