{% extends 'base.html' %}

{% block content %}
    <h1>reminders</h1>
    <form method="post">
        {% csrf_token %}
        <div>
            <select name="{{form.prescription.name}}" id="{{form.prescription.id_for_label}}">
                {% for val, label in form.prescription.field.choices %}
                    <option value="{{ val }}" data-id="{{ val }}" 
                        {% if form.prescription.value == val %}selected{% endif %}>
                        {{label}}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="{{ form.frequency.id_for_label }}">Frequency:</label>
            {{form.frequency}}
        </div>
        <div class="dosage-suggestion"></div>
        <div>
            <label for="{{ form.day_amount.id_for_label }}">Number of days:</label>
            {{form.day_amount}}
            <div class="day-suggestion"></div>
        </div>
        <div id="timeInputs"></div>
        <button type="submit">Submit</button>
    </form>
    <div class="active_reminders">
        {% for reminder in all_reminders %}
            <div class="reminder-layout {% if reminder.is_active %}black{% else %}grayed{% endif %}">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" role="switch" data-type="reminder" data-reminder="{{reminder.id}}" {% if reminder.is_active %}checked{% endif %}>
                </div>
                <p>Medicine: {{reminder.prescription.medicine.name}} ({{reminder.prescription.medicine.brand}})</p>
                <p>Dosage: {{reminder.prescription.medicine.dosage}} mg</p>
                <p>QTY: {{reminder.prescription.quantity}}</p>
                <p class="remaining_days">{{reminder.days_left}} day(s) remaining</p>
                <ul>
                    {% for time in reminder.times.all %}
                        <li>{{ time.time }}</li>
                        <div class="form-check form-switch">
                            <input class="form-check-input time-checkbox" type="checkbox" role="switch" data-type="time" data-id="{{time.id}}" {% if time.is_active %}checked {% endif %} {% if not reminder.is_active %} disabled {% endif %}>
                        </div>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>
        <div class="accordion" id="accordionExample">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                        Archived ({{archived_reminders | length}})
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#accordionExample">
                    <div class="accordion-body">
                        {% for reminder in archived_reminders %}
                            <div id="archive_{{reminder.id}}" class="reminder-layout {% if reminder.is_active %}black{% else %}grayed{% endif %}">
                                <div style="display: none;" class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" role="switch" data-type="reminder" data-reminder="{{reminder.id}}">
                                </div>
                                <p>Medicine: {{reminder.prescription.medicine.name}} ({{reminder.prescription.medicine.brand}})</p>
                                <p>Dosage: {{reminder.prescription.medicine.dosage}} mg</p>
                                <p>QTY: {{reminder.prescription.quantity}}</p>
                                <p class="remaining_days"></p>
                                <ul>
                                    {% for time in reminder.times.all %}
                                        <li>{{ time.time }}</li>
                                        <div class="form-check form-switch">
                                            <input id="time-checkbox" class="form-check-input" type="checkbox" data-type="time" data-id="{{time.id}}" disabled>
                                        </div>
                                    {% endfor %}
                                </ul>
                            </div>
                            <button class="restore-button" type="button" data-reminder="{{reminder.id}}">Restore</button>
                        {% empty %}
                            <div>Nothing to display yet</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const prescriptionSelect = document.querySelector('#id_prescription');
            const frequencySelect = document.querySelector('#frequency');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const suggestionDay = document.querySelector('.day-suggestion');
            const suggestionDosage = document.querySelector('.dosage-suggestion');

            function createSuggestion(){
                const prescription_id = prescriptionSelect.value;
                const frequency = parseInt(frequencySelect.value);

                suggestionDay.innerHTML = "";
                suggestionDosage.innerHTML = "";


                if (prescription_id){
                    fetch("/patient/reminder_suggestions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                        body: JSON.stringify({prescription_id: prescription_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        data.results.forEach(item => {
                            const dosageInfo = document.createElement('p');
                            dosageInfo.classList.add('dosage-info');
                            dosageInfo.textContent = `Dosage information: ${item.dosage}`;
                            suggestionDosage.appendChild(dosageInfo);

                            if (frequency){
                                const quantity = item.quantity;
                                const days = Math.floor(quantity / frequency);

                                const suggestion = document.createElement('p');
                                suggestion.classList.add('daySuggestion');
                                suggestion.textContent = `Based on prescription information it is recommended that you repeat this reminder for ${days} day(s)`;
                                suggestionDay.appendChild(suggestion);
                            }   
                        });
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                } 
            }

            prescriptionSelect.addEventListener('change', createSuggestion);
            frequencySelect.addEventListener('change', createSuggestion);

            const timeInputsDiv = document.getElementById('timeInputs');
            const frequencyDropdown = document.getElementById('frequency');

            frequencyDropdown.addEventListener('change', function(){
                const frequency = parseInt(this.value);
                timeInputsDiv.innerHTML = '';

                for (let i = 0; i < frequency; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `time_${i}`;
                    input.className = 'timeInput'
                    input.placeholder = `Time ${i+1}`;
                    timeInputsDiv.appendChild(input);
                }

                flatpickr(".timeInput", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K",
                    time_24hr: false,
                    defaultDate: "12:00 PM"
                });
            });

            const toggleSwitch = document.querySelectorAll('.form-check-input');
            toggleSwitch.forEach(item => {
                item.addEventListener('change', function(){
                    let url = "";
                    let payload = {};

                    const type = this.getAttribute('data-type')
                    const time_id = this.getAttribute('data-id');
                    const reminder_id = this.getAttribute('data-reminder');

                    if (time_id){
                        url = '/patient/toggle_time';
                        payload = {time_id: time_id};
                    } else if (reminder_id) {
                        url = '/patient/toggle_reminder';
                        payload = {reminder_id: reminder_id};
                    } else {
                        console.error("No valid ID found on this switch")
                        return;
                    }

                    fetch( url, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        body: JSON.stringify(payload)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success){
                            console.log(`Toggle successful for ${time_id ? 'time ' + time_id : 'reminder ' + reminder_id}`);
                            if(type === 'reminder'){
                                document.querySelector('.remaining_days').textContent = `${data.days_left} days remaining`;
                                console.log(data.days_left);

                                const reminderLayout = this.closest('.reminder-layout');
                                reminderLayout.classList.toggle('black', this.checked);
                                reminderLayout.classList.toggle('grayed', !this.checked);
                                
                                const timeCheckboxes = reminderLayout.querySelectorAll('.time-checkbox');

                                timeCheckboxes.forEach(cb => {
                                   if (!this.checked){
                                        cb.disabled = true;
                                        cb.checked = false;
                                   } else {
                                    cb.checked = true;
                                    cb.disabled = false;
                                   }
                                });
                            }
                        } else {
                            console.log('error: toggle failed')
                        }
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                })
            })

            const restoreButton = document.querySelectorAll('.restore-button');
            restoreButton.forEach(btn => {
                const reminder_id = btn.getAttribute('data-reminder');
                btn.addEventListener('click', function(){
                    fetch('/patient/unarchive', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                            body: JSON.stringify({reminder_id: reminder_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success){
                            console.log(`Reminder ${reminder_id} is now active`);
                            const archived_reminder = document.getElementById(`archive_${reminder_id}`)
                            const active_container = document.querySelector('.active_reminders');

                            if (archived_reminder) {
                                active_container.prepend(archived_reminder);

                                archived_reminder.classList.add('black');
                                archived_reminder.classList.remove('grayed');

                                const reminderCheckbox = archived_reminder.querySelector('input[data-type="reminder"]');
                                if (reminderCheckbox) {
                                    reminderCheckbox.disabled = false;
                                    reminderCheckbox.checked = true;
                                }

                                archived_reminder.querySelectorAll('input[data-type="time"]').forEach(cb => {
                                    cb.disabled = false;
                                    cb.checked = true;
                                });

                                archived_reminder.querySelector('.form-check').style.display = 'block';
                                archived_reminder.querySelector('.remaining_days').textContent = `${data.day_amount} day(s) remaining;`

                                btn.remove();
                            } else {
                                console.log('error: unarchiving failed')
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                    
                })
            })
        });
    </script>
{% endblock %}