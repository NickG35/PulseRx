{% extends 'base.html' %}

{% block content %}
    <h1>reminders</h1>
    <form method="post">
        {% csrf_token %}
        <div>
            <select name="{{form.prescription.name}}" id="{{form.prescription.id_for_label}}">
                {% for val, label in form.prescription.field.choices %}
                    <option value="{{ val }}" data-id="{{ val }}" 
                        {% if form.prescription.value == val %}selected{% endif %}>
                        {{label}}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="{{ form.frequency.id_for_label }}">Frequency:</label>
            {{form.frequency}}
        </div>
        <div class="dosage-suggestion"></div>
        <div>
            <label for="{{ form.day_amount.id_for_label }}">Number of days:</label>
            {{form.day_amount}}
            <div class="day-suggestion"></div>
        </div>
        <div id="timeInputs"></div>
        <button type="submit">Submit</button>
    </form>

    {% for reminder in all_reminders %}
        <p>Medicine: {{reminder.prescription.medicine.name}} ({{reminder.prescription.medicine.brand}})</p>
        <p>Dosage: {{reminder.prescription.medicine.dosage}} mg</p>
        <p>QTY: {{reminder.prescription.quantity}}</p>
        <p>{{reminder.frequency}} times</p>
        <p>Take at: 
        <ul>
            {% for time in reminder.times.all %}
                <li>{{ time.time }}</li>
                {% if time.is_active %}
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" data-id="{{time.id}}" checked>
                    </div>
                {% else %}
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" data-id="{{time.id}}">
                    </div>
                {% endif %}
            {% endfor %}
        </ul>
    {% endfor %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const prescriptionSelect = document.querySelector('#id_prescription');
            const frequencySelect = document.querySelector('#frequency');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const suggestionDay = document.querySelector('.day-suggestion');
            const suggestionDosage = document.querySelector('.dosage-suggestion');

            function createSuggestion(){
                const prescription_id = prescriptionSelect.value;
                const frequency = parseInt(frequencySelect.value);

                suggestionDay.innerHTML = "";
                suggestionDosage.innerHTML = "";


                if (prescription_id){
                    fetch("/patient/reminder_suggestions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                        body: JSON.stringify({prescription_id: prescription_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        data.results.forEach(item => {
                            const dosageInfo = document.createElement('p');
                            dosageInfo.classList.add('dosage-info');
                            dosageInfo.textContent = `Dosage information: ${item.dosage}`;
                            suggestionDosage.appendChild(dosageInfo);

                            if (frequency){
                                const quantity = item.quantity;
                                const days = Math.floor(quantity / frequency);

                                const suggestion = document.createElement('p');
                                suggestion.classList.add('daySuggestion');
                                suggestion.textContent = `Based on prescription information it is recommended that you repeat this reminder for ${days} day(s)`;
                                suggestionDay.appendChild(suggestion);
                            }   
                        });
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                } 
            }

            prescriptionSelect.addEventListener('change', createSuggestion);
            frequencySelect.addEventListener('change', createSuggestion);

            const timeInputsDiv = document.getElementById('timeInputs');
            const frequencyDropdown = document.getElementById('frequency');

            frequencyDropdown.addEventListener('change', function(){
                const frequency = parseInt(this.value);
                timeInputsDiv.innerHTML = '';

                for (let i = 0; i < frequency; i++) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = `time_${i}`;
                    input.className = 'timeInput'
                    input.placeholder = `Time ${i+1}`;
                    timeInputsDiv.appendChild(input);
                }

                flatpickr(".timeInput", {
                    enableTime: true,
                    noCalendar: true,
                    dateFormat: "h:i K",
                    time_24hr: false,
                    defaultDate: "12:00 PM"
                });
            });

            const toggleSwitch = document.querySelectorAll('.form-check-input');
            toggleSwitch.forEach(item => {
                item.addEventListener('click', function(){
                    const time_id = item.getAttribute('data-id');
                    fetch('/patient/toggle_time', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                            body: JSON.stringify({time_id: time_id})
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success){
                            console.log(`button for time ${time_id} has been toggled`)
                        } else {
                            console.log('error: button has not been toggled')
                        }
                    })
                    .catch(error => {
                        console.error("Error", error)
                    });
                })
            })
        });
    </script>
{% endblock %}