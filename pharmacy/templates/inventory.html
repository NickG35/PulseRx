{% extends 'base.html' %}

{% block content %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let timeoutID
    const medContainer = document.getElementById('medicineResults');
    const medInput = document.querySelector('.hidden-medicine');
    const medUrl = "{% url 'medicine_search' %}";

    let beforeResultsHTML = '';
    document.getElementById('med-input').addEventListener('keyup', function(){
        clearTimeout(timeoutID)
        const input = this;

        const query = this.value.trim();

        if (query.length === 0) {
            medContainer.innerHTML = ''
            beforeResultsHTML = '';
            return;
        }

        timeoutID = setTimeout(() => {
            fetch(`${medUrl}?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok){
                        throw new Error(`HTTP error status: ${response.status}`);
                    }
                    return response.json()
                })
                .then(data => {
                    const fragment = document.createDocumentFragment();

                    if(data.length > 0) {
                        data.forEach(medicine => {
                          const medItem = document.createElement('div');
                          medItem.classList.add('search-item');

                          const searchLink = document.createElement('a');
                          searchLink.href = `/pharmacy/drug_detail/${medicine.id}`;
                          searchLink.textContent = `${medicine.name} (${medicine.brand}) ID: ${medicine.id}`;
                          searchLink.style.display = 'block';
                          
                          medItem.appendChild(searchLink)
                          fragment.appendChild(medItem);
                        });
                    } else {
                        const noMeds = document.createElement('div');
                        noMeds.textContent = 'No medicine found.';
                        noMeds.classList.add('no-results');
                        fragment.appendChild(noMeds);
                    }

                    const temporaryDiv = document.createElement('div');
                    temporaryDiv.appendChild(fragment.cloneNode(true));
                    const currentHTML = temporaryDiv.innerHTML;

            
                    medContainer.innerHTML = '';
                    medContainer.appendChild(fragment);
                })
                .catch(error => {
                    console.error('Error fetching medicine data:', error);
                    medContainer.innerHTML = `<div class="error-message">Error loading results. Please try again.</div>`;
                });
        }, 300);
    });

    flatpickr(".datepicker", {
            dateFormat: "m-d-Y",
            allowInput: true
    });
  });
</script>
<h2>Inventory</h2>

<input type="text" id="med-input" placeholder="search for medicine..">
<div id="medicineResults"></div>

<div class="med-container">
    {% for drug in page_obj %}
    <div class="med-item">
      <a href="{% url 'drug_detail' drug_id=drug.id %}">
        <div class="image-holder">
          {% if drug.route == "ORAL" %}
          <i id="med-icon" class="fa-solid fa-capsules"></i>
          {% elif drug.route == "RESPIRATORY (INHALATION)" %}
          <i id="med-icon" class="fa-solid fa-lungs"></i>
          {% elif drug.route == "INTRATHECAL" %}
          <i id="med-icon" class="fa-solid fa-syringe"></i>
          {% elif drug.route == "OPHTHALMIC" %}
          <i id="med-icon" class="fa-solid fa-eye"></i>
          {% elif drug.route == "TOPICAL" %}
          <i id="med-icon" class="fa-solid fa-pump-soap"></i>
          {% elif drug.route == "SUBCUTANEOUS" %}
          <i id="med-icon" class="fa-solid fa-syringe"></i>
          {% elif drug.route == "INTRAMUSCULAR" %}
          <i id="med-icon" class="fa-solid fa-syringe"></i>
          {% elif drug.route == "INTRAVENOUS" %}
          <i id="med-icon" class="fa-solid fa-droplet"></i>
          {% elif drug.route == "SUBLINGUAL" %}
          <i id="med-icon" class="fa-solid fa-mouth"></i>
          {% elif drug.route == "NASAL" %}
          <i id="med-icon" class="fa-solid fa-head-side-cough"></i>
          {% endif %}
        </div>
      </a>
      <a href="{% url 'drug_detail' drug_id=drug.id %}">
        <div class="drug-name">
          <p class="drug-title">{{drug.name}}({{drug.brand}})</p>
        </div>
      </a>
    </div>
    {% endfor %}
</div>

<div class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}">Previous</a>
  {% endif %}

  <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}">Next</a>
  {% endif %}
</div>
{% endblock %}