{% extends 'base.html' %}

{% block content %}
<div class="p-6">
  <div class="mb-8">
    <h1 class="text-4xl font-bold text-pulse-gray-800 mb-2">Inventory</h1>
    <p class="text-pulse-gray-600">Track and Manage Medications</p>
  </div>
  {% if messages %}
  <ul class="messages">
      {% for message in messages %}
      <li class="{{ message.tags }}">{{ message }}</li>
      {% endfor %}
  </ul>
  {% endif %}

  <div class="relative flex-1 max-w-2xl mx-auto">
    <label class="input input-lg w-full border-2 border-pulse-gray focus-within:outline-none shadow-md">
        <svg class="h-[1em] opacity-50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <g
            stroke-linejoin="round"
            stroke-linecap="round"
            stroke-width="2.5"
            fill="none"
            stroke="currentColor"
            >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
            </g>
        </svg>
        <input placeholder="search for medicine..." type="text" class="autocomplete-input" data-type="medicine" data-url="{% url 'medicine_search' %}" data-email="no" data-link="yes">
    </label>
    <input type="hidden" class="hidden-medicine">
    <div id="autocompleteResults-medicine" class="absolute top-full left-0 right-0  bg-white border-2 border-t-0 border-pulse-gray rounded-lg z-10 max-h-60 overflow-y-auto"></div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mt-8">
    {% for drug in page_obj %}
      <div class="card bg-white shadow-lg hover:shadow-xl transition-shadow duration-300 border border-pulse-gray-200 rounded-sm">
        <div class="card-body p-6">
          <!-- Icon -->
          <div class="flex justify-center mb-4">
            {% if drug.route == "ORAL" %}
              <i class="fa-solid fa-capsules text-6xl text-pulse-red"></i>
            {% elif drug.route == "RESPIRATORY (INHALATION)" %}
              <i class="fa-solid fa-lungs text-6xl text-pulse-red"></i>
            {% elif drug.route == "INTRATHECAL" %}
              <i class="fa-solid fa-syringe text-6xl text-pulse-red"></i>
            {% elif drug.route == "OPHTHALMIC" %}
              <i class="fa-solid fa-eye text-6xl text-pulse-red"></i>
            {% elif drug.route == "TOPICAL" %}
              <i class="fa-solid fa-pump-soap text-6xl text-pulse-red"></i>
            {% elif drug.route == "SUBCUTANEOUS" %}
              <i class="fa-solid fa-syringe text-6xl text-pulse-red"></i>
            {% elif drug.route == "INTRAMUSCULAR" %}
              <i class="fa-solid fa-syringe text-6xl text-pulse-red"></i>
            {% elif drug.route == "INTRAVENOUS" %}
              <i class="fa-solid fa-droplet text-6xl text-pulse-red"></i>
            {% elif drug.route == "SUBLINGUAL" %}
              <i class="fa-solid fa-mouth text-6xl text-pulse-red"></i>
            {% elif drug.route == "NASAL" %}
              <i class="fa-solid fa-head-side-cough text-6xl text-pulse-red"></i>
            {% endif %}
          </div>

          <!-- Medicine Name and Brand -->
          <div class="mb-4 text-center">
            <a href="{% url 'drug_detail' drug_id=drug.id %}" class="hover:text-pulse-red transition-colors">
              <h3 class="text-2xl font-semibold text-pulse-gray-800">{{ drug.name }}</h3>
              <p class="text-sm text-pulse-gray-500">{{ drug.brand }}</p>
            </a>
          </div>

          <!-- Stock Status Badges -->
          <div class="flex justify-center gap-2 mb-4">
            {% if drug.stock < 1 %}
              <div class="badge badge-error gap-2">
                <i class="fa-solid fa-circle-xmark"></i>
                Out of Stock
              </div>
            {% elif drug.stock <= 30 %}
              <div class="badge badge-warning gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i>
                Low Stock ({{ drug.stock }})
              </div>
            {% else %}
              <div class="badge badge-success gap-2">
                <i class="fa-solid fa-circle-check"></i>
                In Stock ({{ drug.stock }})
              </div>
            {% endif %}
          </div>

          <!-- Resupply Alert -->
          {% if drug.stock <= 30 %}
            {% if drug.resupply_pending %}
              <div class="alert alert-info mb-4">
                <i class="fa-solid fa-clock"></i>
                <div class="text-sm">
                  <p class="font-semibold">Resupply Pending</p>
                  <p class="text-xs">Request under review by pharmacy admin</p>
                </div>
              </div>
            {% endif %}
          {% endif %}

          <!-- Action Buttons -->
          <div class="flex gap-2 mt-4">
            {% if drug.stock <= 30 and request.user.role == 'pharmacy admin' and not drug.resupply_pending %}
              <form action="{% url 'resupply' drug_id=drug.id %}" method="post" class="flex-1">
                {% csrf_token %}
                <button type="submit" class="btn bg-pulse-red hover:bg-pulse-red-dark text-white border-pulse-red w-full">
                  <i class="fa-solid fa-box"></i>
                  Resupply
                </button>
              </form>
            {% endif %}

            <a href="{% url 'drug_detail' drug_id=drug.id %}" class="btn btn-outline hover:bg-pulse-gray-100 hover:border-pulse-gray-400 {% if drug.stock <= 30 and request.user.role == 'pharmacy admin' and not drug.resupply_pending %}{% else %}w-full{% endif %}">
              <i class="fa-solid fa-arrow-right"></i>
              View Details
            </a>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- Pagination -->
  <div class="flex justify-center items-center gap-4 mt-8">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline hover:bg-pulse-gray-100 hover:border-pulse-gray-400">
        <i class="fa-solid fa-chevron-left"></i>
        Previous
      </a>
    {% else %}
      <button class="btn btn-disabled" disabled>
        <i class="fa-solid fa-chevron-left"></i>
        Previous
      </button>
    {% endif %}

    <div class="flex items-center gap-2">
      <span class="text-pulse-gray-600">Page</span>
      <span class="badge badge-lg bg-pulse-red text-white border-pulse-red">{{ page_obj.number }}</span>
      <span class="text-pulse-gray-600">of {{ page_obj.paginator.num_pages }}</span>
    </div>

    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline hover:bg-pulse-gray-100 hover:border-pulse-gray-400">
        Next
        <i class="fa-solid fa-chevron-right"></i>
      </a>
    {% else %}
      <button class="btn btn-disabled" disabled>
        Next
        <i class="fa-solid fa-chevron-right"></i>
      </button>
    {% endif %}
  </div>
</div>
{% endblock %}