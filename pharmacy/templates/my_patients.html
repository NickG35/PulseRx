{% extends 'base.html' %}

{% block content %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let timeoutId; 
        const resultsContainer = document.getElementById('autocompleteResults');
        const patientInput = document.querySelector('.hidden-patient');
        const searchUrl = "{% url 'patient_search' %}";

        let lastResultsHTML = '';

        document.getElementById('search-input').addEventListener('keyup', function(){
            clearTimeout(timeoutId)
            const input = this;
            const query = this.value.trim();

            if (query.length === 0) {
                resultsContainer.innerHTML = ''
                lastResultsHTML = '';
                return;
            }

            timeoutId = setTimeout(() => {
                fetch(`${searchUrl}?q=${encodeURIComponent(query)}`)
                    .then(response => {
                        if (!response.ok){
                            throw new Error(`HTTP error status: ${response.status}`);
                        }
                        return response.json()
                    })
                    .then(data => {
                        const fragment = document.createDocumentFragment();

                        if(data.length > 0) {
                            data.forEach(patient => {
                                const  resultItem = document.createElement('div');
                                resultItem.classList.add('search-item');

                                const searchLink = document.createElement('a');
                                searchLink.href = `/pharmacy/patient_profile/${patient.id}`; 
                                searchLink.textContent =`${patient.first_name} ${patient.last_name} ID: ${patient.id}`;
                                searchLink.style.display = 'block';

                                resultItem.appendChild(searchLink);
                                fragment.appendChild(resultItem);
                            });
                        } else {
                            const noResults = document.createElement('div');
                            noResults.textContent = 'No patients found.';
                            noResults.classList.add('no-results');
                            fragment.appendChild(noResults);
                        }

                        const tempDiv = document.createElement('div');
                        tempDiv.appendChild(fragment.cloneNode(true));
                        const newHTML = tempDiv.innerHTML;

                        resultsContainer.innerHTML = ''; 
                        resultsContainer.appendChild(fragment); 

                    })
                    .catch(error => {
                        console.error('Error fetching patient data:', error);
                        resultsContainer.innerHTML = `<div class="error-message">Error loading results. Please try again.</div>`;
                    });
            }, 300);

        });
    });
</script>
<p>These are my patients</p>
{% if patients %}
    <input type="text" id="search-input" placeholder="search for patients..">
    <div id="autocompleteResults"></div>
    <ul>
        {% for patient in patients %}
            <a href="{% url 'patient_profile' patient_id=patient.id %}">{{ patient.first_name }} {{ patient.last_name }}</a>
        {% endfor %}
    </ul>
{% else %}
    <p>No patients assigned to your pharmacy yet.</p>
{% endif %}
{% endblock %}